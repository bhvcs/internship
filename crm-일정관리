구글 캘린더 api 연동

프로젝트에서 사용자 정보에 접근하려면 토큰이 필요함. 이를 얻기 위해 OAUTH 2.0 or API Key를 사용해야 함.
나는 일단 OAuth2.0 클라이언트 ID를 받긴했음.

비공개 사용자 데이터에 액세스해야 하는 경우에는 OAuth 2.0을 사용해야 합니다. 라네
개인 일정은 분명 비공개 데이터일 것이기 때문에 OAuth 사용해야될 듯

redirect url은 crm 사이트의 로그인 화면이어야 

https://medium.com/iceapple-tech-talks/integration-with-google-calendar-api-using-service-account-1471e6e102c8

calendarId는 캘린더 식별자이며 일정을 만들 캘린더의 이메일 주소이거나 로그인한 사용자의 기본 캘린더를 사용하는 특수 키워드 'primary'일 수 있습니다. 사용하려는 캘린더의 이메일 주소를 모르는 경우 Google Calendar 웹 UI의 캘린더 설정('Calendar Address' 섹션)에서 확인하거나 calendarList.list() 호출 결과에서 확인할 수 있습니다.

service Account 계정으로 캘린더와 연동을 성공함.

이제 캘린더의 일정을 보고 내 db에 반영해야 함. 동기화가 꾸준히 되어야 하므로 5분에 한번씩 호출되게 할거임.
본 api 코드는 .net을 사용해서, 파이썬 배치로 해당 api를 호출하는 식.

본코드:
캘린더에서 데이터를 읽고 db에 반영. 이게 반복되면 같은 스케쥴도 반복해서 생기게 됨.
두가지 방법이 있을 것 같음. 
1. 해당 캘린더에서 읽은 정보는 읽지 않도록 syncToken을 사용.

2. 데이터들을 upsert하기

이제 상담이 생겼을 때 구글 캘린더에 일정 만들기
1. 고객이 상담을 변경했을 때 => 완료
먼저 지워줘야 함
지우고자 하는 history의 시간과 일치하는 event 고르고 거기에 [상담] 있는거 없애기
고객일 때는 상담 변경시 지우기만 하면 됨.

2. 고객이 상담을 삭제 => 완료
그냥 삭제만 하면 됨

admin
상담 승인 => 완료

상담 변경
1. historyId를 보고 기존꺼 삭제
2. 다시 등록인데
이떄 상담사 변경일 때는 기존꺼 삭제할 필요도 없음


상담 취소 => 완료

@시나리오 테스트
1. 고객 상담 신청
2. 어드민 상담 승인 => 캘린더에 표시
3. 고객 상담 변경

어드민 상담 변경 => 표시
어드민 상담 취소 => 표시

=> 확인 완료




TODO
cloud ID
workspace 없애기

상담 예약 => 상담 변경 라우터로 변경 => 해결

투권인 추가될 때도 체크해야됨
ex) 투권인 추가 했을 때, 캘린더 등록 => 그냥 일단 db에 calendar id를 넣어주면 되지 않을까


상담이 두개 신청되는 버그 => 해결

제목 없는 일정일 때 버그 발생 - 설명도 없을 수 있는 것까지 포함해서 => 수정 완료

대면 -> 유선으로 변경시 안바뀜 버그 => 해결

0122

1. 매번 배치를 돌 때 마다, 변경된 일정을 반영해야됨. 지금은 변경되기 전 일정과, 변경된 후의 일정이 함께 들어가고 있음.

 ㄱ. 변경 사항들만 받을 수 있도록 해주는 토큰이 있음. 그걸 관리해서 한다.
 ㄴ. 캘린더의 기간 동안의 일정들을 싹 긁어 와서, db와 비교. 없어진 것은 없애고, 있는건 만들고. 시간으로 쫙 정렬하면, 비교가 쉬울 것 같음.

2. httpclientfactory
해봐야 될지 안될지 판단될 듯

3. calendar 부분에서 오류가 났을 때 대응
_____
현재:
캘린더가 안되면 오류메시지는 날리긴 하는데, 캘린더 외의 로직은 제대로 실행되고 있음
_____
고객 차원에서 캘린더 문제가 발생할 때,
고객 차원에서 캘린더를 건드릴 것은
일정 변경시
일정 취소시
운영에서 위험도는 별로 없음, 왜냐하면 알림톡이 투권인에게 무조건 갈거니깐

crm-고객 입장에서 캘린더가 안된다고 해서 에러메시지가 뜨는건 별로. 차라리 log로 남기자.

log로 남기는건 알겠는데, 그러면 투권인 캘린더에서 빠져야 할게 안빠지면, 알림톡으로는 간다고 해도, 그래도 빼주는게 맞나?
일단 빼주는 것으로 가고
에러가 났을 시에 바로 처리하기 보단 어디 테이블에 적재해서 반영되어야 할 일정을 저장하는거지. 그리고 5분에 한번씩 배치.
안쌓였으면 안해도 되니깐 낫배드. 매번 배치로 정합성 체크하는 것보단 나을 듯. --- 1안

근데 이럴거면 차라리 캘린더에 작업이 필요할 때, 모두 테이블에 적재해서 배치로 처리하는 것도 괜찮을 것 같다. --- 2안
다만 5분에 한번이라면 반영이 바로 바로 안되어서 안좋긴한데, 캘린더 동기화가 그렇게 바로 바로 되어어 하는 것은 아닐수도 있으니.
_____
상담사 차원에서 캘린더가 문제가 발생할 때,

상담 확정만 되고 캘린더에 반영이 안되는게 나은가
or
상담 확정도 안되고 캘린더에 반영이 안되는게 나은가

현재:
상담 확정은 되는데 캘린더에 반영 안될 수 있음
채널톡이 먼저 간다면, 이게 맞을 것 같음.

상담 확정 목록은 캘린더에 반영 안되더라도 db에서 꺼내와 시간 선택에 영향을 주게 됨. 그래서 캘린더와 동기화가 정말 크리티컬하지는 않음.
변경, 취소도 똑같음.
___
결론
그냥 로그로 남기고, db에 에러난 사항들 적재. or 그냥 채널톡으로만 떼우던가.


